{% extends 'base.html' %}

{% block title %}
ALSET: Jobs
{% endblock %}

{% block contents %}
<!--Section: Cards-->
<section class="pt-5">
    <!-- Heading & Description -->
    <div class="wow fadeIn">
        <!--Section heading-->
        <h2 class="h1 text-center mb-5">Jobs</h2>

        <!--Section description-->
        <p class="text-center">
            Take up jobs and earn rewards.
        </p>
    </div>
    <!-- Heading & Description -->

    <div id="div-map" class="row" style="display: none;">
        <div class="col-12">
            <!--Google map-->
            <div id="map-container" class="z-depth-1" style="height: 500px"></div>
        </div>
    </div>

    <div class="row mt-5">
        <div class="col-12">
            <table id="dtBasicExample" class="table table-striped table-bordered" cellspacing="0" width="100%">
                <thead>
                <tr>
                    <th class="th-sm">Id</th>
                    <th class="th-sm">Name</th>
                    <th class="th-sm">Rewards</th>
                    <th class="th-sm">Collateral</th>
                    <th class="th-sm">Poster</th>
                    <th class="th-sm">Added</th>
                    <th class="th-sm">Pickup (Lat)</th>
                    <th class="th-sm">Pickup (Long)</th>
                    <th class="th-sm">Dropoff (Lat)</th>
                    <th class="th-sm">Dropoff (Long)</th>
                    <th class="th-sm">State</th>
                </tr>
                </thead>

                <tbody>
                </tbody>

                <tfoot>
                <tr>
                    <th>Id</th>
                    <th>Name</th>
                    <th>Rewards</th>
                    <th>Collateral</th>
                    <th>Poster</th>
                    <th>Added</th>
                    <th>Pickup (Lat)</th>
                    <th>Pickup (Long)</th>
                    <th>Dropoff (Lat)</th>
                    <th>Dropoff (Long)</th>
                    <th>State</th>
                </tr>
                </tfoot>
            </table>
        </div>
    </div>

    <div class="row mt-5">
        <div class="col-12">
            <div class="card">
                <h5 class="card-header h5">Post new job</h5>

                <div class="card-body">
                    <!-- <h5 class="card-title">Special title treatment</h5> -->

                    <!-- <p class="card-text">With supporting text below as a natural lead-in to additional content.</p> -->

                    <!-- <button type="button" class="btn btn-primary">Add</button> -->

                    <!-- Extended material form grid -->
                    <form>
                        <!-- Grid row -->
                        <div class="form-row">
                            <!-- Grid column -->
                            <div class="col-md-12">
                                <!-- Material input -->
                                <div class="md-form form-group">
                                    <input type="text" class="form-control" id="inputJobName" placeholder="Name">
                                    <label for="inputJobName">Name</label>
                                </div>
                            </div>
                            <!-- Grid column -->
                        </div>
                        <!-- Grid row -->

                        <!-- Grid row -->
                        <div class="form-row">
                            <!-- Grid column -->
                            <div class="col-md-5">
                                <!-- Material input -->
                                <div class="md-form form-group">
                                    <input type="number" class="form-control" id="inputJobReward" min="20">
                                    <label for="inputJobReward">Rewards</label>
                                </div>
                            </div>
                            <!-- Grid column -->

                            <div class="col-md-2"></div>

                            <!-- Grid column -->
                            <div class="col-md-5">
                                <!-- Material input -->
                                <div class="md-form form-group">
                                    <input type="number" class="form-control" id="inputJobCollateral" min="0">
                                    <label for="inputJobCollateral">Collateral</label>
                                </div>
                            </div>
                            <!-- Grid column -->
                        </div>

                        <div class="form-row">
                            <div class="col-md-5 col-12">
                                Pickup point
                                <!--Google map-->
                                <div id="map-container-pickup" class="z-depth-1" style="height: 500px"></div>
                            </div>

                            <div class="col-md-2 col-12"></div>

                            <div class="col-md-5 col-12">
                                Dropoff point
                                <!--Google map-->
                                <div id="map-container-dropoff" class="z-depth-1" style="height: 500px"></div>
                            </div>
                        </div>
                    </form>

                    <br><br><br>

                    <!-- Grid row -->
                    <button id="buttonPostNewJob" class="btn btn-primary btn-md">Post</button>
                    <!-- Extended material form grid -->
                </div>
            </div>
        </div>
    </div>

    <div class="row mt-5">
        <div class="col-12">
            <div class="card">
                <h5 class="card-header h5">Delivered job</h5>

                <div class="card-body">
                    <!-- <h5 class="card-title">Special title treatment</h5> -->

                    <!-- <p class="card-text">With supporting text below as a natural lead-in to additional content.</p> -->

                    <!-- <button type="button" class="btn btn-primary">Add</button> -->

                    <!-- Extended material form grid -->
                    <form>
                        <!-- Grid row -->
                        <div class="form-row">
                            <!-- Grid column -->
                            <div class="col-md-12">
                                <!-- Material input -->
                                <div class="md-form form-group">
                                    <input type="number" class="form-control" id="inputJobIdDelivered" placeholder="" min="0">
                                    <label for="inputJobIdDelivered">Job ID</label>
                                </div>
                            </div>
                            <!-- Grid column -->
                        </div>
                        <!-- Grid row -->
                    </form>

                    <!-- Grid row -->
                    <button id="buttonDeliveredJob" class="btn btn-primary btn-md">Delivered job</button>
                    <!-- Extended material form grid -->
                </div>
            </div>
        </div>
    </div>

    <div class="row mt-5">
        <div class="col-12">
            <div class="card">
                <h5 class="card-header h5">Acknowledge delivery</h5>

                <div class="card-body">
                    <!-- <h5 class="card-title">Special title treatment</h5> -->

                    <!-- <p class="card-text">With supporting text below as a natural lead-in to additional content.</p> -->

                    <!-- <button type="button" class="btn btn-primary">Add</button> -->

                    <!-- Extended material form grid -->
                    <form>
                        <!-- Grid row -->
                        <div class="form-row">
                            <!-- Grid column -->
                            <div class="col-md-12">
                                <!-- Material input -->
                                <div class="md-form form-group">
                                    <input type="number" class="form-control" id="inputJobIdAck" placeholder="" min="0">
                                    <label for="inputJobIdAck">Job ID</label>
                                </div>
                            </div>
                            <!-- Grid column -->
                        </div>
                        <!-- Grid row -->
                    </form>

                    <!-- Grid row -->
                    <button id="buttonAckJob" class="btn btn-primary btn-md">Acknowledge</button>
                    <!-- Extended material form grid -->
                </div>
            </div>
        </div>
    </div>

    <br><br><br><br><br>
</section>
<!--Section: Cards-->
{% endblock %}

{% block scripts %}
<!--Google Maps-->
<script src="https://maps.google.com/maps/api/js"></script>

<script>
    // Google Map
    var map;
    var map_pickup;
    var map_dropoff;

    // Google Map markers
    var markers = [];
    var marker_pickup;
    var marker_dropoff;

    var loc_pickup;
    var loc_dropoff;

    // Adds a marker to the map and push to the array.
    function addJobPickerMarker(jobId, location) {
        console.log("addJobPickerMarker(): location.lat: " + location.lat);
        console.log("addJobPickerMarker(): location.lng: " + location.lng);

        var marker = new google.maps.Marker({
            position: location,
            map: map
        });

        //var infowindow = new google.maps.InfoWindow({
        //    content: "Bla bla black sheep"
        //});

        marker.addListener('click', function() {
            //infowindow.open(map, marker);
            //alert("marker clicked");

            pickJob(parseInt(jobId));
        });

        markers.push(marker);
    }

    // Sets the map on all markers in the array.
    function setMapOnAll(map) {
        for (var i = 0; i < markers.length; i++) {
            markers[i].setMap(map);
        }
    }

    // Removes the markers from the map, but keeps them in the array.
    function clearMarkers() {
        setMapOnAll(null);
    }

    // Shows any markers currently in the array.
    function showMarkers() {
        setMapOnAll(map);
    }

    // Deletes all markers in the array by removing references to them.
    function deleteMarkers() {
        clearMarkers();
        markers = [];
    }

    function getLocation() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition((pos) => {
                location_current_latitude = pos.coords.latitude;
                location_current_longitude = pos.coords.longitude;

                regular_map();
                regular_map_pickup();
                regular_map_dropoff();
            });
        } else {
            alert("Geolocation is not supported by this browser.");
        }
    }
    getLocation();

    // Regular map
    function regular_map() {
        var var_location = new google.maps.LatLng(location_current_latitude, location_current_longitude);

        var var_mapoptions = {
            center: var_location,
            zoom: 14
        };

        map = new google.maps.Map(document.getElementById("map-container"),
            var_mapoptions);

        //var marker = new google.maps.Marker({
        //    position: var_location,
        //    map: map,
        //    title: "Current location"
        //});

        $("#div-map").show();
    }

    function regular_map_pickup() {
        var var_location = new google.maps.LatLng(location_current_latitude, location_current_longitude);

        var var_mapoptions = {
            center: var_location,
            zoom: 14
        };

        map_pickup = new google.maps.Map(document.getElementById("map-container-pickup"),
            var_mapoptions);

        google.maps.event.addListener(map_pickup, 'click', function(event) {
            var lat = event.latLng.lat();
            var lng = event.latLng.lng();
            //alert("lat: " + lat + ", lng: " + lng);

            if (marker_pickup) {
                marker_pickup.setMap(null);
            }
            marker_pickup = new google.maps.Marker({
                position: {
                    lat: lat,
                    lng: lng
                },
                map: map_pickup,
                title: "Pickup location"
            });

            loc_pickup = {
                lat: lat,
                lng: lng
            };
        });
    }

    function regular_map_dropoff() {
        var var_location = new google.maps.LatLng(location_current_latitude, location_current_longitude);

        var var_mapoptions = {
            center: var_location,
            zoom: 14
        };

        map_dropoff = new google.maps.Map(document.getElementById("map-container-dropoff"),
            var_mapoptions);

        google.maps.event.addListener(map_dropoff, 'click', function(event) {
            var lat = event.latLng.lat();
            var lng = event.latLng.lng();
            //alert("lat: " + lat + ", lng: " + lng);

            if (marker_dropoff) {
                marker_dropoff.setMap(null);
            }
            marker_dropoff = new google.maps.Marker({
                position: {
                    lat: lat,
                    lng: lng
                },
                map: map_dropoff,
                title: "Dropoff location"
            });

            loc_dropoff = {
                lat: lat,
                lng: lng
            };
        });
    }

    // Initialize maps
    //google.maps.event.addDomListener(window, 'load', regular_map);

    ///////////////////////////////////////

    var jobCount = 0;
    var jobs = [];

    function addJob(jobName, coinsReward, coinsCollateral, pickupLong, pickupLat, dropoffLong, dropoffLat) {
        if (ALSETContract == null) {
            alert("Not connected to smart contract, please try again later.");
            return;
        }

        // addJob(string jobName, uint coinsReward, uint coinsCollateral, uint pickuplong, uint pickuplat, uint dropofflong, uint dropofflat)
        ALSETContract.methods.addJob(jobName, coinsReward, coinsCollateral, pickupLong, pickupLat, dropoffLong, dropoffLat)
            .send({
                from: account
            })
            .on('transactionHash', (hash) => {
                console.log("addJob(): hash: " + hash);

                var receipt = web3.eth.getTransactionReceipt(hash)
                    .then((receipt) => {
                        console.log("addJob(): Got receipt for transaction: " + hash);

                        updateJobCountAndTable();
                    });
            })
            .on("error", (err) => {
                alert(err.message);
            })
            .on("revert", (err) => {
                alert(err.message);
            });
    }

    function pickJob(jobId) {
        console.log("pickJob(): jobId: " + jobId);

        if (ALSETContract == null) {
            alert("Not yet connected to smart contract, please try again later.");
            return;
        }

        ALSETContract.methods.pickJob(jobId)
            .send({
                from: account
            })
            .on('transactionHash', (hash) => {
                console.log("pickJob(): hash: " + hash);

                var receipt = web3.eth.getTransactionReceipt(hash)
                    .then((receipt) => {
                        console.log("pickJob(): Got receipt for transaction: " + hash);

                        updateJobCountAndTable();

                        // Modify and show dialog box
                        $('#basicExampleModal .modal-title').text("Picked job");
                        $('#basicExampleModal .modal-body').text("You have successfully picked job: " + jobId);
                        $('#basicExampleModal').modal("show");
                    });
            })
            .on("error", (err) => {
                alert(err.message);
            })
            .on("revert", (err) => {
                alert(err.message);
            });
    }

    function updateJobsTable() {
        console.log("Updating jobs table...");

        $("tbody").empty();

        for (var i in jobs) {
            var job = jobs[i];

            $("tbody").append(
                $("<tr>", {
                    "data-id": job.id
                })
                .on("click", function() {
                    var jobId = $(this).data("id");

                    pickJob(parseInt(jobId));
                })
                .append(
                    $("<td>", {
                        text: job.id
                    })
                )
                .append(
                    $("<td>", {
                        text: job.name
                    })
                )
                .append(
                    $("<td>", {
                        text: job.coinsReward
                    })
                )
                .append(
                    $("<td>", {
                        text: job.coinsCollateral
                    })
                )
                .append(
                    $("<td>", {
                        text: job.poster
                    })
                )
                .append(
                    $("<td>", {
                        text: job.timeAdded
                    })
                )
                .append(
                    $("<td>", {
                        text: job.pickupLat
                    })
                )
                .append(
                    $("<td>", {
                        text: job.pickupLong
                    })
                )
                .append(
                    $("<td>", {
                        text: job.dropoffLat
                    })
                )
                .append(
                    $("<td>", {
                        text: job.dropoffLong
                    })
                )
                .append(
                    $("<td>", {
                        text: state_enum_to_string[job.state]
                    })
                )
            );
        }
    };

    function updateJobCountAndTable(retry = false) {
        if (ALSETContract == null) {
            if (retry) {
                setTimeout(() => {
                    updateJobCountAndTable();
                }, 1000);
            }

            return;
        }

        ALSETContract.methods.jobsCount().call().then((count) => {
            // Update
            jobCount = count;
            // Reset
            jobs = [];
            // Delete Google Map markers
            deleteMarkers();

            var promises = [];
            for (var i = 0; i < jobCount; i++) {
                var promise = ALSETContract.methods.jobs(i).call();
                promises.push(promise);
            }
            Promise.all(promises).then((data) => {
                //console.log(data);

                for (var i in data) {
                    var job = data[i];

                    jobs.push({
                        id: job.id,
                        name: job.name,
                        poster: job.poster,
                        dispather: job.dispatcher,

                        coinsReward: job.coinsReward,
                        coinsCollateral: job.coinsCollateral,

                        pickupLong: job.pickuplong / 100000,
                        pickupLat: job.pickuplat / 100000,
                        dropoffLong: job.dropofflong / 100000,
                        dropoffLat: job.dropofflat / 100000,

                        timeAdded: job.timeAdded,
                        timeDelivered: job.timeDelivered,

                        state: job.state
                    });


                    if (job.state == state_string_to_enum["Created"]) {
                        addJobPickerMarker(
                            job.id, {
                                lat: job.pickuplat / 100000,
                                lng: job.pickuplong / 100000
                            }
                        )
                    }
                }

                updateJobsTable();
                showMarkers();
            });
        });
    }

    function getRandomInt(max) {
        return Math.floor(Math.random() * Math.floor(max));
    }
    var POIs = [
        "Mid Valley MegaMall",
        "Sunway Piramid",
        "1 Utama Shopping Center",
        "Jaya Shopping Center",
        "The Curve",

    ];

    function deliveredJob(jobId) {
        if (ALSETContract == null) {
            alert("Not connected to smart contract, please try again later.");
            return;
        }

        ALSETContract.methods.deliveredJob(jobId)
            .send({
                from: account
            })
            .on('transactionHash', (hash) => {
                console.log("deliveredJob(): hash: " + hash);

                var receipt = web3.eth.getTransactionReceipt(hash)
                    .then((receipt) => {
                        console.log("deliveredJob(): Got receipt for transaction: " + hash);

                        updateJobCountAndTable();

                        // Modify and show dialog box
                        $('#basicExampleModal .modal-title').text("Reward yourself");
                        $('#basicExampleModal .modal-body').text("Are you near " + POIs[getRandomInt(POIs.length)] + "? Why not stop by for a coffee?");
                        $('#basicExampleModal').modal("show");
                    });
            })
            .on("error", (err) => {
                alert(err.message);
            })
            .on("revert", (err) => {
                alert(err.message);
            });
    }

    function acknowledgeDelivery(jobId) {
        if (ALSETContract == null) {
            alert("Not connected to smart contract, please try again later.");
            return;
        }

        ALSETContract.methods.acknowledgeDelivery(jobId)
            .send({
                from: account
            })
            .on('transactionHash', (hash) => {
                console.log("acknowledgeDelivery(): hash: " + hash);

                var receipt = web3.eth.getTransactionReceipt(hash)
                    .then((receipt) => {
                        console.log("acknowledgeDelivery(): Got receipt for transaction: " + hash);

                        updateJobCountAndTable();
                    });
            })
            .on("error", (err) => {
                alert(err.message);
            })
            .on("revert", (err) => {
                alert(err.message);
            });
    }

    $(function() {
        //$('#dtBasicExample').DataTable();
        //$('.dataTables_length').addClass('bs-select');

        $("#buttonPostNewJob").click(function() {
            var jobName = $("#inputJobName").val();
            console.log("jobName: " + jobName);

            var jobReward = parseInt($("#inputJobReward").val());
            console.log("jobReward: " + jobReward);

            var jobCollateral = parseInt($("#inputJobCollateral").val());
            console.log("jobCollateral: " + inputJobCollateral);

            var pickupLat = parseInt($("#inputPickupLat").val());
            var pickupLong = parseInt($("#inputPickupLong").val());
            var dropoffLat = parseInt($("#inputDropoffLat").val());
            var dropoffLong = parseInt($("#inputDropoffLong").val());

            if (loc_pickup == null) {
                alert("No pickup location, please click on the pickup map to select a location and try again.");
                return;
            }
            if (loc_dropoff == null) {
                alert("No dropoff location, please click on the dropoff map to select a location and try again");
                return;
            }

            pickupLat = Math.floor(loc_pickup.lat * 100000);
            pickupLong = Math.floor(loc_pickup.lng * 100000);
            dropoffLat = Math.floor(loc_dropoff.lat * 100000);
            dropoffLong = Math.floor(loc_dropoff.lng * 100000);

            console.log("pickupLat: " + pickupLat);
            console.log("pickupLong: " + pickupLong);
            console.log("dropoffLat: " + dropoffLat);
            console.log("dropoffLong: " + dropoffLong);

            addJob(jobName, jobReward, jobCollateral, pickupLong, pickupLat, dropoffLong, dropoffLat);
        });

        $("#buttonDeliveredJob").click(function() {
            var jobId = parseInt($("#inputJobIdDelivered").val());
            console.log("jobId: " + jobId);

            deliveredJob(jobId);
        });

        $("#buttonAckJob").click(function() {
            var jobId = parseInt($("#inputJobIdAck").val());
            console.log("jobId: " + jobId);

            acknowledgeDelivery(jobId);
        });

        updateJobCountAndTable();
        setInterval(() => {
            updateJobCountAndTable();
        }, 5000);
    });
</script>
{% endblock %}

{% block css %}
<style>
    table.dataTable thead>tr>td.sorting,
    table.dataTable thead>tr>td.sorting_asc,
    table.dataTable thead>tr>td.sorting_desc,
    table.dataTable thead>tr>th.sorting,
    table.dataTable thead>tr>th.sorting_asc,
    table.dataTable thead>tr>th.sorting_desc {
        padding-right: 30px
    }

    table.dataTable thead .sorting,
    table.dataTable thead .sorting_asc,
    table.dataTable thead .sorting_asc_disabled,
    table.dataTable thead .sorting_desc,
    table.dataTable thead .sorting_desc_disabled {
        cursor: pointer;
        position: relative
    }

    table.dataTable thead .sorting:after,
    table.dataTable thead .sorting:before,
    table.dataTable thead .sorting_asc:after,
    table.dataTable thead .sorting_asc:before,
    table.dataTable thead .sorting_asc_disabled:after,
    table.dataTable thead .sorting_asc_disabled:before,
    table.dataTable thead .sorting_desc:after,
    table.dataTable thead .sorting_desc:before,
    table.dataTable thead .sorting_desc_disabled:after,
    table.dataTable thead .sorting_desc_disabled:before {
        position: absolute;
        bottom: .9em;
        display: block;
        opacity: .3
    }

    table.dataTable thead .sorting:before,
    table.dataTable thead .sorting_asc:before,
    table.dataTable thead .sorting_asc_disabled:before,
    table.dataTable thead .sorting_desc:before,
    table.dataTable thead .sorting_desc_disabled:before {
        right: 1em;
        content: "\f0de";
        font-family: FontAwesome;
        font-size: 1rem
    }

    table.dataTable thead .sorting:after,
    table.dataTable thead .sorting_asc:after,
    table.dataTable thead .sorting_asc_disabled:after,
    table.dataTable thead .sorting_desc:after,
    table.dataTable thead .sorting_desc_disabled:after {
        content: "\f0dd";
        font-family: FontAwesome;
        right: 16px;
        font-size: 1rem
    }

    table.dataTable thead .sorting_asc:before,
    table.dataTable thead .sorting_desc:after {
        opacity: 1
    }

    table.dataTable thead .sorting_asc_disabled:before,
    table.dataTable thead .sorting_desc_disabled:after {
        opacity: 0
    }
</style>
{% endblock %}
